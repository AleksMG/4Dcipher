<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Недетерминированный S-Box 16×16</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --success: #2ecc71;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        h1, h2, h3 {
            color: var(--primary);
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark);
        }
        
        input, textarea, select, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        button {
            background: var(--secondary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: var(--primary);
        }
        
        .btn-danger {
            background: var(--accent);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .result {
            background: var(--light);
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            min-height: 100px;
            overflow-wrap: break-word;
        }
        
        .sbox-grid {
            display: grid;
            grid-template-columns: repeat(17, 1fr);
            gap: 2px;
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .sbox-header {
            background: var(--primary);
            color: white;
            text-align: center;
            padding: 5px;
            font-weight: bold;
        }
        
        .sbox-cell {
            background: var(--light);
            padding: 5px;
            text-align: center;
            font-size: 12px;
            border: 1px solid #ddd;
            overflow: hidden;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .highlight {
            background-color: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
        
        .log-output {
            height: 200px;
            overflow-y: auto;
            background: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Недетерминированный S-Box 16×16</h1>
        <p>Демонстрация криптосистемы с омофонным шифрованием</p>
    </header>

    <div class="container">
        <div class="column">
            <div class="card">
                <h2>Управление ключом</h2>
                <div class="input-group">
                    <label for="keyInput">Ключ:</label>
                    <input type="text" id="keyInput" placeholder="Введите ключ любой длины" value="МойСекретныйКлюч">
                </div>
                <div class="input-group">
                    <label for="nonceInput">Nonce (одноразовый номер):</label>
                    <input type="text" id="nonceInput" placeholder="Введите nonce" value="12345">
                </div>
                <button id="initBtn" class="btn-success">Инициализировать S-Box</button>
                <button id="resetBtn" class="btn-danger">Сбросить S-Box</button>
                
                <div class="highlight">
                    <p><strong>Улучшения:</strong></p>
                    <ul>
                        <li>Динамический S-Box, зависящий от ключа и nonce</li>
                        <li>Добавление раундовой функции с диффузией</li>
                        <li>Визуализация S-Box и статистики</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>Шифрование</h2>
                <div class="input-group">
                    <label for="rounds">Количество раундов:</label>
                    <select id="rounds">
                        <option value="1">1 раунд</option>
                        <option value="2">2 раунда</option>
                        <option value="3" selected>3 раунда</option>
                        <option value="4">4 раунда</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="plainText">Исходный текст:</label>
                    <textarea id="plainText" rows="4" placeholder="Введите текст для шифрования">Привет, мир! Это демонстрация недетерминированного S-Box.</textarea>
                </div>
                <button id="encryptBtn">Зашифровать</button>
                <div class="result" id="encryptedResult">
                    <p>Результат шифрования появится здесь...</p>
                </div>
            </div>
        </div>

        <div class="column">
            <div class="card">
                <h2>Дешифрование</h2>
                <div class="input-group">
                    <label for="cipherText">Шифртекст (в hex):</label>
                    <textarea id="cipherText" rows="4" placeholder="Шифртекст в hex формате"></textarea>
                </div>
                <button id="decryptBtn">Дешифровать</button>
                <div class="result" id="decryptedResult">
                    <p>Результат дешифрования появится здесь...</p>
                </div>
            </div>

            <div class="card">
                <h2>Визуализация S-Box</h2>
                <div class="sbox-grid" id="sboxGrid">
                    <!-- S-Box будет отрисован здесь -->
                </div>
            </div>

            <div class="card">
                <h2>Статистика и мониторинг</h2>
                <div class="stats">
                    <div class="stat-card">
                        <h3>Энтропия S-Box</h3>
                        <p id="entropyValue">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>Размер ключа</h3>
                        <p id="keySize">-</p>
                    </div>
                </div>
                
                <h3>Журнал операций:</h3>
                <div class="log-output" id="logOutput"></div>
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let sBox = null;
        let invSBox = null;
        let prng = null;
        const logOutput = document.getElementById('logOutput');

        // Логирование
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logOutput.innerHTML += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // Хеш-функция (упрощенная для демонстрации)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0; // Преобразование в 32-битное целое
            }
            return hash;
        }

        // Криптографически стойкий ГПСЧ (упрощенный для демонстрации)
        function createPRNG(seed) {
            let state = simpleHash(seed.toString());
            return {
                nextByte: function() {
                    state ^= state << 13;
                    state ^= state >> 17;
                    state ^= state << 5;
                    return state & 0xFF; // Возвращает младшие 8 бит
                }
            };
        }

        // Функция диффузии (улучшение)
        function diffusionMix(data, round) {
            const result = new Uint8Array(data.length);
            for (let i = 0; i < data.length; i++) {
                // Простая операция диффузии с использованием соседних байтов
                const prev = i > 0 ? data[i - 1] : round;
                const next = i < data.length - 1 ? data[i + 1] : round;
                result[i] = (data[i] ^ prev ^ next ^ round) & 0xFF;
            }
            return result;
        }

        // Генерация S-Box
        function generateSBox(key, nonce = '') {
            log(`Генерация S-Box с ключом: ${key} и nonce: ${nonce}`);
            const seed = key + nonce;
            prng = createPRNG(seed);
            
            const sbox = Array.from({length: 16}, () => 
                Array.from({length: 16}, () => [])
            );
            
            const usedValues = new Set();
            
            // Заполняем S-Box уникальными значениями
            for (let i = 0; i < 16; i++) {
                for (let j = 0; j < 16; j++) {
                    const values = [];
                    while (values.length < 16) {
                        const candidate = prng.nextByte();
                        if (!usedValues.has(candidate)) {
                            values.push(candidate);
                            usedValues.add(candidate);
                        }
                    }
                    sbox[i][j] = values;
                }
            }
            
            log('S-Box успешно сгенерирован');
            return sbox;
        }

        // Построение обратного отображения
        function buildInverseMapping(sbox) {
            log('Построение обратного mapping...');
            const inverse = {};
            for (let i = 0; i < 16; i++) {
                for (let j = 0; j < 16; j++) {
                    for (const value of sbox[i][j]) {
                        inverse[value] = [i, j];
                    }
                }
            }
            return inverse;
        }

        // Визуализация S-Box
        function renderSBox() {
            const grid = document.getElementById('sboxGrid');
            grid.innerHTML = '';
            
            // Добавляем заголовки столбцов
            grid.appendChild(createCell('', 'sbox-header'));
            for (let j = 0; j < 16; j++) {
                grid.appendChild(createCell(j.toString(16).toUpperCase(), 'sbox-header'));
            }
            
            // Добавляем строки с данными
            for (let i = 0; i < 16; i++) {
                grid.appendChild(createCell(i.toString(16).toUpperCase(), 'sbox-header'));
                for (let j = 0; j < 16; j++) {
                    const values = sBox[i][j].map(v => v.toString(16).padStart(2, '0').toUpperCase());
                    grid.appendChild(createCell(values.join(' '), 'sbox-cell'));
                }
            }
            
            // Обновляем статистику
            updateStats();
        }

        function createCell(content, className) {
            const cell = document.createElement('div');
            cell.textContent = content;
            cell.className = className;
            return cell;
        }

        function updateStats() {
            // Вычисляем энтропию S-Box (упрощенный расчет)
            const valueCount = new Array(256).fill(0);
            for (let i = 0; i < 16; i++) {
                for (let j = 0; j < 16; j++) {
                    for (const value of sBox[i][j]) {
                        valueCount[value]++;
                    }
                }
            }
            
            // Все значения должны встречаться ровно 16 раз
            const entropy = valueCount.filter(count => count === 16).length / 256;
            document.getElementById('entropyValue').textContent = entropy.toFixed(4);
            
            // Размер ключа
            const key = document.getElementById('keyInput').value;
            document.getElementById('keySize').textContent = `${key.length} символов (${new Blob([key]).size} байт)`;
        }

        // Шифрование с несколькими раундами
        function encrypt(text, rounds = 3) {
            log(`Начало шифрования (${rounds} раунда)`);
            const textBytes = new TextEncoder().encode(text);
            let encryptedData = new Uint8Array(textBytes);
            
            // Многократное применение шифрования с диффузией
            for (let round = 0; round < rounds; round++) {
                log(`Раунд шифрования ${round + 1}/${rounds}`);
                
                // Применяем диффузию
                if (round > 0) {
                    encryptedData = diffusionMix(encryptedData, round);
                }
                
                // Применяем S-Box подстановку
                const roundResult = new Uint8Array(encryptedData.length);
                for (let k = 0; k < encryptedData.length; k++) {
                    const byte = encryptedData[k];
                    const i = (byte >> 4) & 0x0F;
                    const j = byte & 0x0F;
                    
                    // Случайный выбор омофона
                    const randomIndex = Math.floor(Math.random() * 16);
                    roundResult[k] = sBox[i][j][randomIndex];
                }
                
                encryptedData = roundResult;
            }
            
            // Преобразуем в hex-строку
            const hexResult = Array.from(encryptedData)
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
                
            log('Шифрование завершено');
            return hexResult;
        }

        // Дешифрование с несколькими раундами
        function decrypt(hexData, rounds = 3) {
            log(`Начало дешифрования (${rounds} раунда)`);
            
            // Преобразуем hex в байты
            const bytes = new Uint8Array(hexData.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
            let decryptedData = new Uint8Array(bytes);
            
            // Обрабатываем раунды в обратном порядке
            for (let round = rounds - 1; round >= 0; round--) {
                log(`Раунд дешифрования ${rounds - round}/${rounds}`);
                
                // Обратная S-Box подстановка
                const roundResult = new Uint8Array(decryptedData.length);
                for (let k = 0; k < decryptedData.length; k++) {
                    const byte = decryptedData[k];
                    const [i, j] = invSBox[byte];
                    roundResult[k] = (i << 4) | j;
                }
                
                decryptedData = roundResult;
                
                // Обратная диффузия (такая же как и прямая)
                if (round > 0) {
                    decryptedData = diffusionMix(decryptedData, round);
                }
            }
            
            log('Дешифрование завершено');
            return new TextDecoder().decode(decryptedData);
        }

        // Инициализация приложения
        function initApp() {
            log('Приложение инициализировано');
            
            // Обработчики событий
            document.getElementById('initBtn').addEventListener('click', () => {
                const key = document.getElementById('keyInput').value;
                const nonce = document.getElementById('nonceInput').value;
                
                if (!key) {
                    alert('Пожалуйста, введите ключ');
                    return;
                }
                
                sBox = generateSBox(key, nonce);
                invSBox = buildInverseMapping(sBox);
                renderSBox();
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                sBox = null;
                invSBox = null;
                document.getElementById('sboxGrid').innerHTML = '';
                document.getElementById('entropyValue').textContent = '-';
                log('S-Box сброшен');
            });
            
            document.getElementById('encryptBtn').addEventListener('click', () => {
                if (!sBox) {
                    alert('Сначала инициализируйте S-Box');
                    return;
                }
                
                const text = document.getElementById('plainText').value;
                const rounds = parseInt(document.getElementById('rounds').value);
                
                const encrypted = encrypt(text, rounds);
                document.getElementById('encryptedResult').innerHTML = 
                    `<p><strong>Шифртекст (hex):</strong></p><p>${encrypted}</p>`;
                
                // Автоматически заполняем поле для дешифрования
                document.getElementById('cipherText').value = encrypted;
            });
            
            document.getElementById('decryptBtn').addEventListener('click', () => {
                if (!sBox) {
                    alert('Сначала инициализируйте S-Box');
                    return;
                }
                
                const cipherText = document.getElementById('cipherText').value;
                const rounds = parseInt(document.getElementById('rounds').value);
                
                if (!cipherText) {
                    alert('Введите шифртекст для дешифрования');
                    return;
                }
                
                try {
                    const decrypted = decrypt(cipherText, rounds);
                    document.getElementById('decryptedResult').innerHTML = 
                        `<p><strong>Результат дешифрования:</strong></p><p>${decrypted}</p>`;
                } catch (e) {
                    alert('Ошибка дешифрования: неверный формат шифртекста');
                    console.error(e);
                }
            });
        }

        // Запуск приложения после загрузки страницы
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
