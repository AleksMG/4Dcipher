<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞–±–æ—á–∏–π S-Box 16x16</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', monospace;
        }
        body {
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #161b22;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #30363d;
        }
        h1 {
            color: #58a6ff;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #0d1117;
            border-radius: 8px;
            border: 1px solid #30363d;
        }
        textarea, input, button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            background: #0d1117;
            color: #c9d1d9;
            border: 1px solid #30363d;
            border-radius: 5px;
            font-size: 14px;
        }
        textarea {
            height: 80px;
            font-family: 'Courier New', monospace;
        }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 12px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background: #2ea043;
        }
        .output {
            padding: 15px;
            background: #0d1117;
            border-radius: 5px;
            border: 1px solid #30363d;
            min-height: 60px;
            word-break: break-all;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .debug {
            font-size: 12px;
            color: #8b949e;
            margin-top: 10px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            background: #1c2b39;
            color: #58a6ff;
            border-radius: 5px;
            border: 1px solid #1f6feb;
            text-align: center;
        }
        .s-box-grid {
            display: grid;
            grid-template-columns: repeat(17, 1fr);
            gap: 2px;
            margin-top: 15px;
            font-size: 11px;
        }
        .s-box-cell {
            padding: 8px 4px;
            text-align: center;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 3px;
            cursor: pointer;
        }
        .s-box-cell:hover {
            background: #30363d;
        }
        .header-cell {
            background: #238636;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê –†–∞–±–æ—á–∏–π S-Box 16√ó16 —Å 16 –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –≤ —è—á–µ–π–∫–µ</h1>

        <div class="section">
            <h2>üì• –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</h2>
            <textarea id="inputText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...">Hello World 123</textarea>
            <input type="text" id="key" value="secret_key_123" placeholder="–ö–ª—é—á">
            
            <button onclick="initSBox()">üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å S-Box</button>
            <button onclick="encrypt()">üîí –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="decrypt()">üîì –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å</button>
            
            <div id="status" class="status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
        </div>

        <div class="section">
            <h2>üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç</h2>
            <div id="output" class="output">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å...</div>
            <div id="debug" class="output debug">–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...</div>
        </div>

        <div class="section">
            <h2>üî¢ S-Box 16√ó16 (–ø–µ—Ä–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)</h2>
            <div id="sBoxGrid" class="s-box-grid"></div>
        </div>
    </div>

    <script>
        let sBox = [];
        let inverseMap = new Map();

        // –ü—Ä–æ—Å—Ç–æ–π –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π PRNG
        function createCryptoPRNG(seed) {
            let state = new Uint32Array([seed, seed ^ 0xDEADBEEF, seed ^ 0xCAFEBABE, seed ^ 0x12345678]);
            let position = 0;
            
            return function() {
                if (position >= state.length) {
                    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    for (let i = 0; i < state.length; i++) {
                        state[i] = state[i] ^ (state[(i + 1) % state.length] << 13);
                        state[i] = state[i] ^ (state[i] >> 17);
                        state[i] = state[i] ^ (state[i] << 5);
                    }
                    position = 0;
                }
                
                const value = state[position] % 256 / 255;
                position++;
                return value;
            };
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ seed –∏–∑ –∫–ª—é—á–∞
        function createSeed(key) {
            let hash = 0;
            for (let i = 0; i < key.length; i++) {
                hash = ((hash << 5) - hash) + key.charCodeAt(i);
                hash |= 0; // Convert to 32-bit integer
            }
            return Math.abs(hash);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è S-Box
        function initSBox() {
            const key = document.getElementById('key').value;
            if (!key) {
                showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á');
                return;
            }

            const seed = createSeed(key);
            const random = createCryptoPRNG(seed);
            
            sBox = [];
            inverseMap.clear();

            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            const usedValues = new Set();

            // –ó–∞–ø–æ–ª–Ω—è–µ–º S-Box 16x16
            for (let i = 0; i < 16; i++) {
                sBox[i] = [];
                for (let j = 0; j < 16; j++) {
                    sBox[i][j] = [];
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 16 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —è—á–µ–π–∫–∏ [i][j]
                    for (let k = 0; k < 16; k++) {
                        let value;
                        let attempts = 0;
                        
                        do {
                            value = Math.floor(random() * 256);
                            attempts++;
                            
                            if (attempts > 1000) {
                                // Fallback: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
                                value = (i * 16 + j + k * 256) % 256;
                                if (usedValues.has(value)) {
                                    value = (value + 1) % 256;
                                }
                            }
                        } while (usedValues.has(value));
                        
                        usedValues.add(value);
                        sBox[i][j][k] = value;
                        inverseMap.set(value, { i, j });
                    }
                }
            }

            renderSBox();
            showStatus('‚úÖ S-Box —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ S-Box
        function renderSBox() {
            const grid = document.getElementById('sBoxGrid');
            grid.innerHTML = '';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏
            for (let i = 0; i < 17; i++) {
                const cell = document.createElement('div');
                cell.className = 's-box-cell header-cell';
                cell.textContent = i === 0 ? 'i\\j' : (i - 1).toString(16).toUpperCase();
                grid.appendChild(cell);
            }

            // –î–∞–Ω–Ω—ã–µ
            for (let i = 0; i < 16; i++) {
                const headerCell = document.createElement('div');
                headerCell.className = 's-box-cell header-cell';
                headerCell.textContent = i.toString(16).toUpperCase();
                grid.appendChild(headerCell);

                for (let j = 0; j < 16; j++) {
                    const cell = document.createElement('div');
                    cell.className = 's-box-cell';
                    const firstValue = sBox[i][j][0];
                    cell.textContent = firstValue.toString(16).padStart(2, '0').toUpperCase();
                    
                    // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å–æ –≤—Å–µ–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                    const allValues = sBox[i][j].map(v => 
                        v.toString(16).padStart(2, '0').toUpperCase()
                    ).join(' ');
                    cell.title = `S[${i.toString(16).toUpperCase()}][${j.toString(16).toUpperCase()}]: ${allValues}`;
                    
                    grid.appendChild(cell);
                }
            }
        }

        // –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
        function encrypt() {
            if (sBox.length === 0) {
                showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ S-Box');
                return;
            }

            const text = document.getElementById('inputText').value;
            if (!text) {
                showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤ –±–∞–π—Ç—ã
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            
            let encryptedBytes = [];
            let debugInfo = "üîí –®–ò–§–†–û–í–ê–ù–ò–ï:\n";

            for (let i = 0; i < data.length; i++) {
                const byte = data[i];
                const row = (byte >> 4) & 0x0F; // –°—Ç–∞—Ä—à–∏–µ 4 –±–∏—Ç–∞
                const col = byte & 0x0F;        // –ú–ª–∞–¥—à–∏–µ 4 –±–∏—Ç–∞

                // –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä –∏–∑ 16 –∑–Ω–∞—á–µ–Ω–∏–π
                const randomIndex = Math.floor(Math.random() * 16);
                const encryptedByte = sBox[row][col][randomIndex];

                encryptedBytes.push(encryptedByte);
                
                debugInfo += `–ë–∞–π—Ç ${i}: 0x${byte.toString(16).padStart(2, '0').toUpperCase()} ‚Üí `;
                debugInfo += `S[${row.toString(16).toUpperCase()}][${col.toString(16).toUpperCase()}][${randomIndex}] = `;
                debugInfo += `0x${encryptedByte.toString(16).padStart(2, '0').toUpperCase()}\n`;
            }

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ HEX —Å—Ç—Ä–æ–∫—É
            const hexResult = encryptedBytes.map(b => 
                b.toString(16).padStart(2, '0').toUpperCase()
            ).join(' ');

            document.getElementById('output').textContent = hexResult;
            document.getElementById('debug').textContent = debugInfo;
            showStatus('‚úÖ –¢–µ–∫—Å—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω');
        }

        // –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
        function decrypt() {
            if (sBox.length === 0) {
                showStatus('‚ùå –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ S-Box');
                return;
            }

            const input = document.getElementById('inputText').value.trim();
            if (!input) {
                showStatus('‚ùå –í–≤–µ–¥–∏—Ç–µ HEX –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            // –ü–∞—Ä—Å–∏–º HEX —Å—Ç—Ä–æ–∫—É
            const hexBytes = input.split(/\s+/);
            const bytes = hexBytes.map(hex => {
                const value = parseInt(hex, 16);
                return isNaN(value) ? 0 : value;
            });

            let decryptedBytes = [];
            let debugInfo = "üîì –î–ï–®–ò–§–†–û–í–ê–ù–ò–ï:\n";
            let errorCount = 0;

            for (let i = 0; i < bytes.length; i++) {
                const encryptedByte = bytes[i];
                
                if (inverseMap.has(encryptedByte)) {
                    const { i: row, j: col } = inverseMap.get(encryptedByte);
                    const originalByte = (row << 4) | col;
                    decryptedBytes.push(originalByte);
                    
                    debugInfo += `–ë–∞–π—Ç ${i}: 0x${encryptedByte.toString(16).padStart(2, '0').toUpperCase()} ‚Üí `;
                    debugInfo += `S[${row.toString(16).toUpperCase()}][${col.toString(16).toUpperCase()}] ‚Üí `;
                    debugInfo += `0x${originalByte.toString(16).padStart(2, '0').toUpperCase()}\n`;
                } else {
                    decryptedBytes.push(63); // '?' –≤ ASCII
                    debugInfo += `–ë–∞–π—Ç ${i}: 0x${encryptedByte.toString(16).padStart(2, '0').toUpperCase()} ‚Üí ‚ùå –û–®–ò–ë–ö–ê\n`;
                    errorCount++;
                }
            }

            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –±–∞–π—Ç—ã –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ç–µ–∫—Å—Ç
            const decoder = new TextDecoder();
            const textResult = decoder.decode(new Uint8Array(decryptedBytes));

            document.getElementById('output').textContent = textResult;
            document.getElementById('debug').textContent = debugInfo + (errorCount > 0 ? `\n‚ùå –û—à–∏–±–æ–∫: ${errorCount}` : '');
            showStatus(errorCount > 0 ? `‚ö†Ô∏è –î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ —Å ${errorCount} –æ—à–∏–±–∫–∞–º–∏` : '‚úÖ –¢–µ–∫—Å—Ç –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω');
        }

        function showStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = initSBox;
    </script>
</body>
</html>
